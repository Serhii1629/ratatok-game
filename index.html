<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RATATOK</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  background: #121212;
  color: white;
  font-family: Arial, sans-serif;
}
header {
  text-align: center;
  padding: 16px;
  font-size: 24px;
  background: #1f1f1f;
}
.panel { display: none; padding-bottom: 120px; }
.panel.active { display: block; }

.menu {
  position: fixed;
  bottom: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  background: #1f1f1f;
  padding: 18px 0;
  font-size: 22px;
}

#rat {
  font-size: 180px;
  text-align: center;
  margin: 30px 0;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
#rat, #rat:active, #rat:focus {
  transform: none !important;
  transition: none !important;
}

button {
  width: 90%;
  margin: 10px auto;
  padding: 14px;
  font-size: 18px;
  display: block;
}
</style>
</head>

<body>

<header>ğŸ­ RATATOK</header>

<!-- GAME -->
<div id="game" class="panel active">
  <div id="rat">ğŸ€</div>
  <p style="text-align:center">
    Ğ¢Ğ°Ğ¿Ñ‹: <span id="score">0</span><br>
    Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ: <span id="energy">100</span><br>
    Ğ¡Ğ¸Ğ»Ğ°: <span id="power">1</span>
  </p>
</div>

<!-- CARDS -->
<div id="cards" class="panel">
  <h2 style="text-align:center">ğŸƒ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸</h2>
  <div id="cardList"></div>
</div>

<!-- SHOP -->
<div id="shop" class="panel">
  <h2 style="text-align:center">ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</h2>
  <button onclick="buyEnergy()">+50 ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸ â€” 100</button>
</div>

<!-- AIRDROP -->
<div id="airdrop" class="panel">
  <h2 style="text-align:center">ğŸª™ RATATOK AIRDROP</h2>
  <p style="text-align:center">
    â­ ĞÑ‡ĞºĞ¸: <span id="airdrop">0</span><br>
    ğŸ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾: <b><span id="reward">0</span> RATATOK</b>
  </p>
  <button onclick="copyRef()">ğŸ”— ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ°</button>
</div>

<!-- MENU -->
<div class="menu">
  <div onclick="openPanel('game')">ğŸ®</div>
  <div onclick="openPanel('cards')">ğŸƒ</div>
  <div onclick="openPanel('shop')">ğŸ›’</div>
  <div onclick="openPanel('airdrop')">ğŸª™</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* STATE */
let score = Number(localStorage.getItem("score")) || 0;
let energy = Number(localStorage.getItem("energy")) || 100;
let power = Number(localStorage.getItem("power")) || 1;
let airdrop = Number(localStorage.getItem("airdrop")) || 0;

/* UI */
const scoreEl = document.getElementById("score");
const energyEl = document.getElementById("energy");
const powerEl = document.getElementById("power");
const airdropEl = document.getElementById("airdrop");
const rewardEl = document.getElementById("reward");
const ratEl = document.getElementById("rat");

/* CARDS */
const cards = Array.from({ length: 5 }).map((_, i) => ({
  id: i,
  level: Number(localStorage.getItem("card_" + i)) || 0,
  bonus: i + 1,
  price: 200 * (i + 1)
}));

ratEl.onclick = () => {
  if (energy <= 0) return;
  score += power;
  energy--;
  airdrop++;
  save();
  update();
};

function renderCards() {
  const list = document.getElementById("cardList");
  list.innerHTML = "";
  cards.forEach(c => {
    const cost = c.price * (c.level + 1);
    const btn = document.createElement("button");
    btn.textContent = `ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° ${c.id + 1} | Ğ£Ñ€.${c.level} | Ğ¦ĞµĞ½Ğ° ${cost}`;
    btn.onclick = () => {
      if (score >= cost) {
        score -= cost;
        c.level++;
        power += c.bonus;
        localStorage.setItem("card_" + c.id, c.level);
        save();
        update();
        renderCards();
      }
    };
    list.appendChild(btn);
  });
}

function buyEnergy() {
  if (score >= 100) {
    score -= 100;
    energy = Math.min(100, energy + 50);
    save();
    update();
  }
}

function openPanel(id) {
  document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if (id === "cards") renderCards();
}

function copyRef() {
  if (!tg.initDataUnsafe.user) return;
  const id = tg.initDataUnsafe.user.id;
  navigator.clipboard.writeText(`https://t.me/Ğ¢Ğ’ĞĞ™_Ğ‘ĞĞ¢?start=ref_${id}`);
  tg.showAlert("Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°");
}

function save() {
  localStorage.setItem("score", score);
  localStorage.setItem("energy", energy);
  localStorage.setItem("power", power);
  localStorage.setItem("airdrop", airdrop);
}

function update() {
  scoreEl.textContent = score;
  energyEl.textContent = energy;
  powerEl.textContent = power;
  airdropEl.textContent = airdrop;
  rewardEl.textContent = Math.floor(airdrop * 0.3);
}
update();

/* REFERRAL AUTH */
if (tg.initDataUnsafe.user) {
  fetch("/api/auth", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      telegram_id: tg.initDataUnsafe.user.id,
      username: tg.initDataUnsafe.user.username || "",
      ref: tg.initDataUnsafe.start_param || null
    })
  });
}
</script>

</body>
</html>
