<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RATATOK</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
}

header {
    text-align: center;
    font-size: 24px;
    padding: 16px;
    background: #1f1f1f;
}

/* –ü–ê–ù–ï–õ–ò */
.panel {
    display: none;
    padding-bottom: 120px;
}
.panel.active {
    display: block;
}

/* –¶–ï–ù–¢–† */
.game-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

/* –ö–†–´–°–ê ‚Äî –ë–ï–ó –£–í–ï–õ–ò–ß–ï–ù–ò–Ø */
#rat-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
}

#rat {
    font-size: 190px;
    margin: 30px 0;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

/* –°–¢–ê–¢–´ */
.stats {
    font-size: 18px;
    text-align: center;
}

/* –ú–ï–ù–Æ */
.menu {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #1f1f1f;
    display: flex;
    justify-content: space-around;
    padding: 20px 0;
    font-size: 22px;
    border-top: 2px solid #333;
}

.menu div {
    padding: 12px 18px;
}

/* –ö–ù–û–ü–ö–ò */
button {
    width: 90%;
    margin: 10px auto;
    padding: 14px;
    font-size: 18px;
    display: block;
}
</style>
</head>

<body>

<header>üê≠ RATATOK</header>

<!-- GAME -->
<div id="game" class="panel active game-center">
    <div id="rat-wrapper">
        <div id="rat">üêÄ</div>
    </div>
    <div class="stats">
        –¢–∞–ø—ã: <span id="score">0</span><br>
        –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">100</span>/100<br>
        –ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä: <span id="auto">0</span>
    </div>
</div>

<!-- SHOP -->
<div id="shop" class="panel">
    <h2 style="text-align:center">üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
    <button onclick="buyAuto()">–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä (+1) ‚Äî 200</button>
    <button onclick="buyEnergy()">–≠–Ω–µ—Ä–≥–∏—è +50 ‚Äî 100</button>
</div>

<!-- MENU -->
<div class="menu">
    <div onclick="openPanel('game')">üéÆ</div>
    <div onclick="openPanel('shop')">üõí</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* ===== –†–ï–§–ï–†–ê–õ (–û–î–ò–ù –†–ê–ó) ===== */
if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    const user = tg.initDataUnsafe.user;
    const startParam = tg.initDataUnsafe.start_param;

    fetch("/api/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            telegram_id: user.id,
            username: user.username || "",
            ref: startParam || null
        })
    });
}

/* ===== –°–û–°–¢–û–Ø–ù–ò–ï ===== */
let score = Number(localStorage.getItem("score")) || 0;
let energy = Number(localStorage.getItem("energy")) || 100;
let auto = Number(localStorage.getItem("auto")) || 0;
let power = Number(localStorage.getItem("power")) || 1;

/* ===== –ö–†–´–°–´ –ü–û –£–†–û–í–ù–Ø–ú ===== */
const rats = [
    { taps: 0, icon: "üêÄ" },
    { taps: 500, icon: "üêÅ" },
    { taps: 2000, icon: "üê≠" },
    { taps: 5000, icon: "üêπ" },
    { taps: 15000, icon: "üëëüê≠" }
];

/* ===== –≠–õ–ï–ú–ï–ù–¢–´ ===== */
const scoreEl = document.getElementById("score");
const energyEl = document.getElementById("energy");
const autoEl = document.getElementById("auto");
const ratEl = document.getElementById("rat");

/* ===== –°–û–•–†–ê–ù–ï–ù–ò–ï ===== */
function save() {
    localStorage.setItem("score", score);
    localStorage.setItem("energy", energy);
    localStorage.setItem("auto", auto);
    localStorage.setItem("power", power);
}

/* ===== UI ===== */
function updateUI() {
    scoreEl.textContent = score;
    energyEl.textContent = energy;
    autoEl.textContent = auto;

    let currentRat = rats[0].icon;
    rats.forEach(r => {
        if (score >= r.taps) currentRat = r.icon;
    });
    ratEl.textContent = currentRat;
}

/* ===== –¢–ê–ü ===== */
ratEl.onclick = () => {
    if (energy <= 0) return;
    score += power;
    energy -= 1;
    updateUI();
    save();
};

/* ===== –ê–í–¢–û–ö–õ–ò–ö–ï–† ===== */
setInterval(() => {
    if (auto > 0 && energy > 0) {
        const spend = Math.min(auto, energy);
        score += spend;
        energy -= spend;
        updateUI();
        save();
    }
}, 1000);

/* ===== –ú–ê–ì–ê–ó–ò–ù ===== */
function buyAuto() {
    if (score >= 200) {
        score -= 200;
        auto += 1;
        updateUI();
        save();
    }
}

function buyEnergy() {
    if (score >= 100) {
        score -= 100;
        energy = Math.min(100, energy + 50);
        updateUI();
        save();
    }
}

/* ===== –ú–ï–ù–Æ ===== */
function openPanel(id) {
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

updateUI();
</script>

</body>
</html>
